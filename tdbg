#!/usr/bin/env tarantool

local colors   = require "term.colors"
local debugger = require 'tdebug.debugger'
local argparse = require "argparse"

local parseArgument = function()
    local parser = argparse()
        :name "tdebug"
        :description "Better Tarantool shell"

    parser:argument "input"
        :description "A lua or sql file to run or debug"
        :args "?"

    parser:argument "arguments"
        :description "Arguments to pass to <input>"
        :args "*"

    parser:flag "-d --debugger"
        :description "Run tdebug in debugger mode"

    return parser:parse()
end

local function motto()
    debugger.writeln("Tarantool Debugger wrapper:")
end

local handle = function(arguments)
    -- If breakpoint defined, enter debugger mode
    local breakpointsStr = arguments["debugger"]
    local breakpoints = {}

    if breakpointsStr and arguments.input then
        debugger.dofile('tdbg', arguments.input, unpack(arguments.arguments))
    elseif breakpointsStr and not arguments.input then
        print(colors.red("Illegal use of --debugger: missing input file"))
        return
    elseif not breakpointsStr and arguments.input then
        -- cdo.runFile(arguments.input, arguments.arguments)
    else
        -- Regular REPL
        -- require "croissant.repl"()
    end
end

motto()

handle(parseArgument())

os.exit(0)
